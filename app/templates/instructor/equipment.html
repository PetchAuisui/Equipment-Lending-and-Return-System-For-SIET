{% extends 'base/base_teacher.html' %}
{% block title %}Equipment{% endblock %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/equipment.css') }}">

<div class="header-bar">
  <h1 class="Title">ระบบยืมอุปกรณ์ (Instructor)</h1>
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="ค้นหาอุปกรณ์..." onkeyup="filterDevices()">
    <select id="categoryFilter" onchange="filterDevices()">
      <option value="">ทุกหมวดหมู่</option>
      {% set categories = (equipments.available + equipments.unavailable) | map(attribute='category') | unique %}
      {% for cat in categories %}
      <option value="{{ cat }}">{{ cat }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<div class="device-container">
  {# ===== พร้อมยืม ===== #}
  {% for item in equipments.available %}
  <div class="device_box" style="background-color: {{ item.status_color }};"
       data-name="{{ item.name | lower }}" data-category="{{ item.category | lower }}">
    <img class="image"
         src="{{ item.image_url }}"
         alt="{{ item.name }}"
         onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/device/default.png') }}'">
    <div class="device_info">
      <span class="device_name">{{ item.name }}</span>
      <span class="amount">จำนวนคงเหลือ : {{ item.amount }}</span>
    </div>
    <div class="button_group">
      <a href="#" class="btn btn-detail">รายละเอียด</a>
      {% if current_user.is_authenticated %}
        <a href="{{ url_for('inventory.lend', codes=item.codes|join(','), name=item.name, image=item.image_url) }}" class="btn btn-borrow">ยืม</a>
      {% else %}
        <a href="{{ url_for('auth.login_page') }}" class="btn btn-borrow">ยืม</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}

  {# ===== ไม่พร้อมยืม ===== #}
  {% for item in equipments.unavailable %}
  <div class="device_box" style="background-color: {{ item.status_color }};"
       data-name="{{ item.name | lower }}" data-category="{{ item.category | lower }}">
    <img class="image"
         src="{{ item.image_url }}"
         alt="{{ item.name }}"
         onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/device/default.png') }}'">
    <div class="device_info">
      <span class="device_name">{{ item.name }}</span>
      <span class="amount">ไม่พร้อมสำหรับการยืม</span>
    </div>
    <div class="button_group">
      <a href="#" class="btn btn-detail">รายละเอียด</a>
    </div>
  </div>
  {% endfor %}
</div>

<script>
function filterDevices() {
  const searchValue = document.getElementById('searchInput').value.toLowerCase();
  const categoryValue = document.getElementById('categoryFilter').value.toLowerCase();
  const devices = document.querySelectorAll('.device_box');
  devices.forEach(device => {
    const name = device.dataset.name;
    const category = device.dataset.category;
    device.style.display = (name.includes(searchValue) && (category.includes(categoryValue) || categoryValue === "")) ? '' : 'none';
  });
}
</script>
{% endblock %}