{% extends 'base/base_teacher.html' %}
{% block title %}Track Status{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/instructor.css') }}">

<style>
/* เสริมบางส่วนให้ตารางอ่านง่าย กรณีโปรเจ็กต์ยังไม่มีคลาสเหล่านี้ */
.page-head { display:flex; gap:.5rem; align-items:center; margin:.5rem 0 1rem; flex-wrap:wrap; }
.page-head form { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
.page-head input[type="text"], .page-head select { padding:.4rem .6rem; border:1px solid #e5e7eb; border-radius:8px; }
.page-head button { padding:.45rem .8rem; border:none; border-radius:8px; background:#16a34a; color:#fff; font-weight:700; cursor:pointer; }

.table-wrap { overflow:auto; margin-top: .5rem; }
.tbl { width:100%; border-collapse:collapse; font-size: 0.95rem; }
.tbl th, .tbl td { border:1px solid #e5e7eb; padding:.5rem .6rem; text-align:left; white-space:nowrap; }
.tbl thead th { background:#f3f4f6; font-weight:700; }
.pill { padding:.15rem .5rem; border-radius:999px; font-weight:700; font-size:.85rem; }
.pill.ok { background:#dcfce7; color:#166534; }
.pill.bad { background:#fee2e2; color:#7f1d1d; }
.pill.wait { background:#fef3c7; color:#7c2d12; }
.muted { color:#6b7280; }
</style>

<div class="page-head">
  <form method="get" action="{{ url_for('instructor.track_status') }}">
    <select name="status">
      {% set s = active_status or 'ALL' %}
      {% for opt in ['ALL','PENDING','APPROVED','REJECTED','RETURNED'] %}
      <option value="{{ opt }}" {{ 'selected' if s==opt else '' }}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="text" name="q" placeholder="ค้นหาชื่อ/อีเมล/อุปกรณ์..." value="{{ q }}">
    <button type="submit">ค้นหา</button>
  </form>
</div>

<div class="table-wrap">
  <table class="tbl">
    <thead>
      <tr>
        <th>#</th>
        <th>วันที่ยืม</th>
        <th>กำหนดคืน</th>
        <th>ผู้ยืม</th>
        <th>อุปกรณ์</th>
        <th>รายวิชา</th>
        <th>สถานะ</th>
      </tr>
    </thead>
    <tbody>
      {% for r in reqs %}
      <tr>
        <td>{{ loop.revindex }}</td>
        <td>{{ (r.start_date or r.created_at)|default('', true) }}</td>
        <td>{{ r.due_date or '' }}</td>
        <td>
          {{ r.user.name if r.user else '-' }}
          <div class="muted">{{ r.user.email if r.user else '' }}</div>
        </td>
        <td>
          {{ r.equipment.name if r.equipment else '-' }}
          <div class="muted">{{ r.equipment.code if r.equipment else '' }}</div>
        </td>
        <td>{{ r.subject.subject_name if r.subject else '-' }}</td>
        <td>
          {% set st = (r.status.name if r.status else 'PENDING') %}
          {% if st == 'APPROVED' %}
            <span class="pill ok">APPROVED</span>
          {% elif st == 'REJECTED' %}
            <span class="pill bad">REJECTED</span>
          {% elif st in ['RETURNED', 'COMPLETED'] %}
            <span class="pill ok">RETURNED</span>
          {% else %}
            <span class="pill wait">PENDING</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7" class="muted" style="text-align:center;">ไม่มีข้อมูล</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}