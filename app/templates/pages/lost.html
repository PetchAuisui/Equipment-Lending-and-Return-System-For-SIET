{% extends 'base/blank.html' %}
{% block title %}แจ้งอุปกรณ์สูญหายหรือเสียหาย{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/lost.css') }}">
{% endblock %}

{% block content %}
  <div class="lost-wrapper">

    <header class="lost-header">
      <i class="ri-file-edit-line"></i>
      <div class="lost-heading">แจ้งอุุปกรณ์สูญหายหรือเสียหาย</div>
    </header>

    <form class="lost-card" method="post" enctype="multipart/form-data">

      <div class="row small">
        <label>ประเภทการแจ้ง</label>
        <select name="report_type" class="input" required>
          <option value="">-- เลือกประเภท --</option>
          <option value="lost">สูญหาย</option>
          <option value="damaged">เสียหาย</option>
        </select>
      </div>

      <div class="row">
        <label>ชื่อ-นามสกุล</label>
        <input name="full_name" class="input" type="text" placeholder="ชื่อ-นามสกุล" required>
      </div>

      <div class="row">
        <label>เบอร์โทร</label>
        <input name="phone" class="input" type="text" placeholder="081-xxx-xxxx" required>
      </div>

      <div class="row">
        <label>อุปกรณ์ที่ยืมมาที่เกิดปัญหา</label>
        <input name="device" class="input" type="text" placeholder="ชื่ออุปกรณ์" 
               value="{{ request.args.equipment_name or '' }}" 
               required>
      </div>

      <div class="row two-col">
        <div>
          <label>ประเภท</label>
          <input name="type" class="input" type="text">
        </div>
        <div>
          <label>ID</label>
          <input name="device_id" class="input" type="text"
                 value="{{ request.args.equipment_code or '' }}">
        </div>
      </div>

      {% if request.args.rent_id %}
      <input type="hidden" name="rent_id" value="{{ request.args.rent_id }}">
      {% endif %}

      <div class="row">
        <label>วันที่หาย/สูญหาย</label>
        <div class="date-row">
          <input name="lost_day" class="input date" type="text" placeholder="DD" required>
          <span class="sep">/</span>
          <input name="lost_month" class="input date" type="text" placeholder="MM" required>
          <span class="sep">/</span>
          <input name="lost_year" class="input date" type="text" placeholder="YYYY" required>
          <i class="ri-calendar-line cal"></i>
        </div>
      </div>

      <div class="row">
        <label>สถานที่ที่ทำหาย/สูญหาย</label>
        <input name="place" class="input" type="text" placeholder="สถานที่ที่ทำหาย" required>
      </div>

      <div class="row">
        <label>รายละเอียดปัญหา</label>
        <textarea name="detail" class="input textarea" rows="4" placeholder="รายละเอียดเพิ่มเติม..."></textarea>
      </div>

      <div class="row actions">
        <div class="upload">
          <label class="muted">อัปโหลดรูป</label>
          <input name="images" type="file" class="file">
        </div>
        <div class="submit">
          <div class="error-message" id="errorMessage" role="alert" aria-live="assertive" style="display:none"></div>
          <button type="submit" class="btn-send" id="sendBtn" disabled>send</button>
        </div>
      </div>

    </form>
  </div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const form = document.querySelector('.lost-card');
    const sendBtn = document.getElementById('sendBtn');
    const errorMessage = document.getElementById('errorMessage');

    // fields to validate
    const requiredSelectors = [
      '[name="report_type"]',
      '[name="full_name"]',
      '[name="phone"]',
      '[name="device"]',
      '[name="lost_day"]',
      '[name="lost_month"]',
      '[name="lost_year"]',
      '[name="place"]'
    ];

    function getFields(){
      return requiredSelectors.map(s=>document.querySelector(s));
    }

    function validate(){
      const fields = getFields();
      let valid = true;
      let firstInvalid = null;
      fields.forEach(f=>{
        if(!f) return;
        const v = (f.value || '').trim();
        if(!v){
          valid = false;
          f.classList.add('invalid');
          if(!firstInvalid) firstInvalid = f;
        } else {
          f.classList.remove('invalid');
        }
      });
      if(valid){
        errorMessage.style.display='none';
        sendBtn.disabled = false;
      } else {
        errorMessage.textContent = 'กรุณากรอกข้อมูลที่จำเป็นทั้งหมดก่อนส่งแบบฟอร์ม';
        errorMessage.style.display='block';
        sendBtn.disabled = true;
      }
      return {valid, firstInvalid};
    }

    // validate on input/change
    getFields().forEach(f=>{ if(f) f.addEventListener('input', validate); if(f) f.addEventListener('change', validate); });

    form.addEventListener('submit', function(e){
      const res = validate();
      if(!res.valid){
        e.preventDefault();
        if(res.firstInvalid) res.firstInvalid.focus();
      }
    });

    // initial check
    document.addEventListener('DOMContentLoaded', validate);
    // also run immediately in case DOMContentLoaded already fired
    validate();
  })();
</script>
{% endblock %}