{% extends 'base/base_admin.html' %}
{% block title %}แก้ไขสมาชิก{% endblock %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/edit_user.css') }}">

<div class="admin-scope">
  <main class="admin-content">
    <div class="admin-users">
      <div class="container">

        <h2>แก้ไขข้อมูลสมาชิก</h2>

        <div class="alerts">
          {% if error %}
            <div class="alert alert-error">{{ error }}</div>
          {% endif %}
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for cat, msg in messages %}
                <div class="alert alert-{{ cat }}">{{ msg }}</div>
              {% endfor %}
            {% endif %}
          {% endwith %}
        </div>

        {# ================== ฟอร์มหลัก: แก้ไขข้อมูลผู้ใช้ ================== #}
        <form method="post"
              action="{{ url_for('admin_users.edit_user_action', user_id=user.user_id) }}">

          <!-- ===== ช่องรหัส ===== -->
          <div class="form-group" id="group-student-id">
            <label for="student_id">รหัสนักศึกษา:</label>
            <input id="student_id" type="text" name="student_id"
                   value="{{ (old.student_id if old else user.student_id) or '' }}"
                   placeholder="เช่น 65070xxxx">
          </div>

          <div class="form-group" id="group-employee-id">
            <label for="employee_id">รหัสบุคลากร:</label>
            <input id="employee_id" type="text" name="employee_id"
                   value="{{ (old.employee_id if old else user.employee_id) or '' }}"
                   placeholder="เช่น TCH-001 หรือ STF-320">
          </div>

          <!-- ===== ฟิลด์ทั่วไป ===== -->
          <div class="form-group">
            <label>ชื่อ:</label>
            <input type="text" name="name" value="{{ user.name }}" required>
          </div>

          <div class="form-group">
            <label>อีเมล:</label>
            <input type="email" name="email" value="{{ user.email }}" required>
          </div>

          <div class="form-group">
            <label>เบอร์โทร:</label>
            <input type="text" name="phone" value="{{ user.phone or '' }}">
          </div>

          <!-- ===== สาขาวิชา ===== -->
          {% set selected_major = (old.major if old and old.get('major') else user.major or '') %}
          <div class="form-group">
            <label for="major">สาขาวิชา:</label>
            <select id="major" class="auth__input" name="major" required>
              <option value="" {{ "selected" if selected_major == "" else "" }}>กรุณาเลือกสาขา</option>

              <optgroup label="ครุศาสตร์สถาปัตยกรรม">
                <option value="ครุศาสตร์สถาปัตยกรรม" {{ "selected" if selected_major=="ครุศาสตร์สถาปัตยกรรม" else "" }}>ครุศาสตร์สถาปัตยกรรม</option>
                <option value="ครุศาสตร์การออกแบบ (หลักสูตร 5 ปี)" {{ "selected" if selected_major=="ครุศาสตร์การออกแบบ (หลักสูตร 5 ปี)" else "" }}>ครุศาสตร์การออกแบบ (หลักสูตร 5 ปี)</option>
                <option value="สถาปัตยกรรม (หลักสูตร 5 ปี)" {{ "selected" if selected_major=="สถาปัตยกรรม (หลักสูตร 5 ปี)" else "" }}>สถาปัตยกรรม (หลักสูตร 5 ปี)</option>
                <option value="การออกแบบสภาพแวดล้อมภายใน (หลักสูตร 5 ปี)" {{ "selected" if selected_major=="การออกแบบสภาพแวดล้อมภายใน (หลักสูตร 5 ปี)" else "" }}>การออกแบบสภาพแวดล้อมภายใน (หลักสูตร 5 ปี)</option>
                <option value="ครุศาสตร์การออกแบบ (หลักสูตร 4 ปี)" {{ "selected" if selected_major=="ครุศาสตร์การออกแบบ (หลักสูตร 4 ปี)" else "" }}>ครุศาสตร์การออกแบบ (หลักสูตร 4 ปี)</option>
                <option value="นวัตกรรมและเทคโนโลยีการออกแบบ" {{ "selected" if selected_major=="นวัตกรรมและเทคโนโลยีการออกแบบ" else "" }}>นวัตกรรมและเทคโนโลยีการออกแบบ</option>
              </optgroup>

              <optgroup label="ครุศาสตร์อุตสาหกรรม">
                <option value="ครุศาสตร์อุตสาหกรรม" {{ "selected" if selected_major=="ครุศาสตร์อุตสาหกรรม" else "" }}>ครุศาสตร์อุตสาหกรรม</option>
                <option value="วิทยาการจัดการเรียนรู้" {{ "selected" if selected_major=="วิทยาการจัดการเรียนรู้" else "" }}>วิทยาการจัดการเรียนรู้</option>
              </optgroup>

              <optgroup label="ครุศาสตร์วิศวกรรม">
                <option value="ครุศาสตร์วิศวกรรม" {{ "selected" if selected_major=="ครุศาสตร์วิศวกรรม" else "" }}>ครุศาสตร์วิศวกรรม</option>
                <option value="ครุศาสตร์วิศวกรรม (หลักสูตร 5 ปี)" {{ "selected" if selected_major=="ครุศาสตร์วิศวกรรม (หลักสูตร 5 ปี)" else "" }}>ครุศาสตร์วิศวกรรม (หลักสูตร 5 ปี)</option>
                <option value="เทคโนโลยีอิเล็กทรอนิกส์ (ต่อเนื่อง)" {{ "selected" if selected_major=="เทคโนโลยีอิเล็กทรอนิกส์ (ต่อเนื่อง)" else "" }}>เทคโนโลยีอิเล็กทรอนิกส์ (ต่อเนื่อง)</option>
                <option value="ครุศาสตร์วิศวกรรม (หลักสูตร 4 ปี)" {{ "selected" if selected_major=="ครุศาสตร์วิศวกรรม (หลักสูตร 4 ปี)" else "" }}>ครุศาสตร์วิศวกรรม (หลักสูตร 4 ปี)</option>
                <option value="เทคโนโลยีคอมพิวเตอร์" {{ "selected" if selected_major=="เทคโนโลยีคอมพิวเตอร์" else "" }}>เทคโนโลยีคอมพิวเตอร์</option>
                <option value="อิเล็กทรอนิกส์และโทรคมนาคม" {{ "selected" if selected_major=="อิเล็กทรอนิกส์และโทรคมนาคม" else "" }}>อิเล็กทรอนิกส์และโทรคมนาคม</option>
              </optgroup>

              <optgroup label="ครุศาสตร์เกษตร">
                <option value="ครุศาสตร์เกษตร" {{ "selected" if selected_major=="ครุศาสตร์เกษตร" else "" }}>ครุศาสตร์เกษตร</option>
                <option value="ครุศาสตร์เกษตร (หลักสูตร 5 ปี)" {{ "selected" if selected_major=="ครุศาสตร์เกษตร (หลักสูตร 5 ปี)" else "" }}>ครุศาสตร์เกษตร (หลักสูตร 5 ปี)</option>
                <option value="เทคโนโลยีชีวภาพทางการเกษตร (ต่อเนื่อง)" {{ "selected" if selected_major=="เทคโนโลยีชีวภาพทางการเกษตร (ต่อเนื่อง)" else "" }}>เทคโนโลยีชีวภาพทางการเกษตร (ต่อเนื่อง)</option>
                <option value="ครุศาสตร์เกษตร (หลักสูตร 4 ปี)" {{ "selected" if selected_major=="ครุศาสตร์เกษตร (หลักสูตร 4 ปี)" else "" }}>ครุศาสตร์เกษตร (หลักสูตร 4 ปี)</option>
              </optgroup>

              <optgroup label="หมวดอื่น ๆ">
                <option value="ภาษาและสังคม" {{ "selected" if selected_major=="ภาษาและสังคม" else "" }}>ภาษาและสังคม</option>
                <option value="สำนักงานมาตราฐานครุศาสตร์อุตสาหกรรมและเทคโนโลยี" {{ "selected" if selected_major=="สำนักงานมาตราฐานครุศาสตร์อุตสาหกรรมและเทคโนโลยี" else "" }}>สำนักงานมาตราฐานครุศาสตร์อุตสาหกรรมและเทคโนโลยี</option>
                <option value="เทคโนโลยีบัณฑิต (บูรณาการนวัตกรรมเพื่อสินค้าและบริการ)" {{ "selected" if selected_major=="เทคโนโลยีบัณฑิต (บูรณาการนวัตกรรมเพื่อสินค้าและบริการ)" else "" }}>เทคโนโลยีบัณฑิต (บูรณาการนวัตกรรมเพื่อสินค้าและบริการ)</option>
              </optgroup>
            </select>
          </div>

          <!-- ===== ประเภทสมาชิก ===== -->
          <div class="form-group">
            <label>ประเภทสมาชิก:</label>
            <select name="member_type" id="member_type">
              <option value="student"  {% if user.member_type=='student' %}selected{% endif %}>นักศึกษา</option>
              <option value="teacher"  {% if user.member_type=='teacher' %}selected{% endif %}>อาจารย์</option>
              <option value="officer"  {% if user.member_type=='officer' %}selected{% endif %}>เจ้าหน้าที่</option>
            </select>
          </div>

          <!-- ===== เพศ ===== -->
          <div class="form-group">
            <label>เพศ:</label>
            <select name="gender">
              <option value="male"   {% if user.gender=='male' %}selected{% endif %}>ชาย</option>
              <option value="female" {% if user.gender=='female' %}selected{% endif %}>หญิง</option>
              <option value="other"  {% if user.gender=='other' %}selected{% endif %}>อื่นๆ</option>
            </select>
          </div>

          <!-- ===== สิทธิ์การใช้งาน ===== -->
          {% set selected_role = (old.role if old and old.get('role') else user.role or "member") %}
          <div class="form-group">
            <label for="role">สิทธิ์การใช้งาน:</label>
            <select id="role" name="role" required>
              <option value="member" {{ "selected" if selected_role=="member" else "" }}>สมาชิกทั่วไป</option>
              <option value="staff"  {{ "selected" if selected_role=="staff" else "" }}>ผู้ดูแลระบบ</option>
            </select>
          </div>

          <!-- ปุ่มของฟอร์มหลัก -->
          <div class="form-actions">
            <button type="submit" class="btn btn-save">บันทึก</button>
            <a href="{{ url_for('admin_users.index') }}" class="btn btn-cancel">ยกเลิก</a>
          </div>

        </form>  {# ===== END ฟอร์มหลัก ===== #}

        {# ================== ฟอร์ม B: แอดมินตั้งรหัสใหม่ให้เลย ================== #}
        <section class="form-section security" style="margin-top:20px">
          <h3>ความปลอดภัย / รหัสผ่าน</h3>
          <p class="muted">ตั้งรหัสผ่านใหม่</p>

          <form method="post"
                action="{{ url_for('admin_users.admin_set_password', user_id=user.user_id) }}"
                class="security-row set-password">
            {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}

            <div class="form-group" style="flex:1">
              <label>รหัสผ่านใหม่:</label>
              <input type="password" name="new_password" minlength="6" placeholder="อย่างน้อย 6 ตัวอักษร" required>
            </div>

            <div class="form-group" style="flex:1">
              <label>ยืนยันรหัสผ่าน:</label>
              <input type="password" name="confirm_password" minlength="6" placeholder="พิมพ์ซ้ำอีกครั้ง" required>
            </div>

            <div class="form-group" style="display:flex; gap:8px; align-items:flex-end">
              <button type="button" class="btn btn-soft" id="btn-toggle-pw">แสดง/ซ่อน</button>
              <button type="submit" class="btn btn-danger">บันทึกรหัสผ่านใหม่</button>
            </div>
          </form>
        </section>

      </div>
    </div>
  </main>
</div>

<script>
  // ==== toggle ช่องรหัสนักศึกษา/บุคลากร ตามประเภทสมาชิก ====
  const memberSelect = document.getElementById('member_type');
  const studentGroup = document.getElementById('group-student-id');
  const employeeGroup = document.getElementById('group-employee-id');

  function toggleIdFields() {
    const val = memberSelect.value;
    if (val === 'student') {
      studentGroup.style.display = 'flex';
      employeeGroup.style.display = 'none';
    } else {
      studentGroup.style.display = 'none';
      employeeGroup.style.display = 'flex';
    }
  }
  if (memberSelect) {
    toggleIdFields();
    memberSelect.addEventListener('change', toggleIdFields);
  }

  // ==== Helpers: สุ่มรหัส / แสดง-ซ่อนรหัส ====
  function genRandomPassword(len = 12) {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%^&*?";
    let out = "";
    for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
    return out;
  }

  const btnGen = document.getElementById('btn-gen-pw');
  const btnToggle = document.getElementById('btn-toggle-pw');

  if (btnGen) {
    btnGen.addEventListener('click', () => {
      const pw1 = document.querySelector('.set-password input[name="new_password"]');
      const pw2 = document.querySelector('.set-password input[name="confirm_password"]');
      const rand = genRandomPassword(12);
      pw1.value = rand;
      pw2.value = rand;
      pw1.focus();
      pw1.select();
    });
  }

  if (btnToggle) {
    btnToggle.addEventListener('click', () => {
      document.querySelectorAll('.set-password input[name="new_password"], .set-password input[name="confirm_password"]')
        .forEach(inp => {
          inp.type = (inp.type === 'password') ? 'text' : 'password';
        });
    });
  }
</script>

{% endblock %}
