{% extends 'base/base_admin.html' %}
{% block title %}รายละเอียดแจ้งสูญหาย/ชำรุด{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/lost.css') }}">

<div style="padding:40px 24px; display:flex; justify-content:center;">
  <div style="width:95%; max-width:900px; margin:0 auto; position:relative; left:50%; transform:translateX(-50%);">
    <h2 style="text-align:center; margin-bottom:18px;">รายละเอียดการแจ้ง</h2>

    <div class="lost-card" style="padding:22px; box-shadow:0 10px 30px rgba(10,20,40,0.06); border-radius:10px; background:#fff;">
      <div style="display:flex; gap:20px; align-items:flex-start;">
        <div style="flex:1;">
          <p style="margin:0 0 8px 0;"><strong>ID:</strong> {{ item.item_broke_id }}</p>
          <p style="margin:0 0 8px 0;"><strong>รหัสเช่า:</strong> {{ item.rent_id }}</p>
          <p style="margin:0 0 12px 0;"><strong>อุปกรณ์:</strong> {{ item.rent_return and item.rent_return.equipment and item.rent_return.equipment.name or item.equipment_name }}</p>
          <p style="margin:0 0 8px 0;"><strong>ประเภทแจ้ง:</strong>
            {% set t = item.type or '' %}
            {% if t.lower() in ['lost','สูญหาย'] %}
              <span style="color:#d9534f;font-weight:700;">สูญหาย</span>
            {% elif t.lower() in ['damaged','เสียหาย'] %}
              <span style="color:#d9534f;font-weight:700;">เสียหาย</span>
            {% else %}
              {{ item.type }}
            {% endif %}
          </p>
          <p style="margin:12px 0 8px 0;"><strong>รายละเอียด:</strong></p>
          <div id="detail-box" data-original-detail="{{ (item.detail or '')|e }}" style="background:#fafafa;border:1px solid #eee;padding:12px;border-radius:6px;">{{ item.detail or '-' }}</div>

          <p style="margin-top:12px;"><strong>สถานะปัจจุบัน:</strong>
            <span id="current-status" style="font-weight:700;">
            {% if item.status in ['lost','สูญหาย','damaged'] %}
              <span style="color:#d9534f;font-weight:700;">{{ item.status }}</span>
            {% elif item.status == 'ส่งซ่อม' %}
              <span style="color:#f0ad4e;font-weight:700;">{{ item.status }}</span>
            {% elif item.status == 'พร้อมใช้งาน' %}
              <span style="color:#28a745;font-weight:700;">{{ item.status }}</span>
            {% else %}
              <span>{{ item.status }}</span>
            {% endif %}
            </span>
          </p>
        </div>

        <div style="width:260px;">
          <p><strong>รูปหลักฐาน</strong></p>
          {% if item.item_broke_images %}
            <div style="display:flex;flex-direction:column;gap:8px;">
              {% for im in item.item_broke_images %}
                <a href="{{ url_for('static', filename=im.image_path) }}" target="_blank">
                  <img src="{{ url_for('static', filename=im.image_path) }}" alt="img" style="width:100%; border:1px solid #eee; border-radius:6px;">
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div style="background:#fafafa;border:1px dashed #ddd;padding:36px;text-align:center;border-radius:6px;color:#777;">ไม่มีรูป</div>
          {% endif %}

          <div style="margin-top:16px;">
            <form action="{{ url_for('admin.lost_report_update', item_id=item.item_broke_id) }}" method="post">
              <label style="display:block; font-weight:700; margin-bottom:6px;">อัพเดทสถานะ</label>
              <select name="update_status" class="input" required style="width:100%; padding:8px; border-radius:6px; border:1px solid #e6e9ef;">
                <option value="">-- เลือกสถานะ --</option>
                <option value="ส่งซ่อม">ส่งซ่อม</option>
                <option value="พร้อมใช้งาน">พร้อมใช้งาน</option>
              </select>
              <div style="display:flex; gap:8px; margin-top:12px;">
                <button type="submit" class="btn blue" style="flex:1;">send</button>
                <a class="btn" href="{{ url_for('admin.lost_reports') }}" style="flex:1; text-align:center;">ยกเลิก</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const sel = document.querySelector('select[name="update_status"]');
  const currentStatusEl = document.getElementById('current-status');
  const detailBox = document.getElementById('detail-box');
  // determine original reported type
  const reportedType = "{{ (item.type or '')|e }}".toLowerCase();

  function setStatusVisual(status){
    if(!currentStatusEl) return;
    let html = '';
    if(['lost','สูญหาย','damaged','เสียหาย'].includes(status.toLowerCase())){
      html = '<span style="color:#d9534f;font-weight:700;">'+ status +'</span>';
    } else if(status === 'ส่งซ่อม'){
      html = '<span style="color:#f0ad4e;font-weight:700;">'+ status +'</span>';
    } else if(status === 'พร้อมใช้งาน'){
      html = '<span style="color:#28a745;font-weight:700;">'+ status +'</span>';
    } else {
      html = '<span>'+ status +'</span>';
    }
    currentStatusEl.innerHTML = html;
  }

  if(sel){
    sel.addEventListener('change', function(){
      const v = this.value || '';
      // if admin sets to ready, show green and append previous-type note
      if(v === 'พร้อมใช้งาน'){
        setStatusVisual(v);
        if(detailBox){
          const orig = detailBox.getAttribute('data-original-detail') || '';
          // only append once
          if(!detailBox.innerText.includes('ประเภทเก่า')){
            const prev = reportedType.includes('damaged') || reportedType.includes('เสียหาย') ? 'เสียหาย' : 'สูญหาย';
            const note = ' (ประเภทเก่า ' + prev + ')';
            detailBox.innerText = (orig || detailBox.innerText || '-') + note;
          }
        }
      } else {
        // revert visual to selected value (or keep original)
        setStatusVisual(v || '{{ item.status|e }}');
        // if changed away from ready, restore original detail text
        if(detailBox){
          const orig = detailBox.getAttribute('data-original-detail') || '';
          detailBox.innerText = orig || detailBox.innerText.replace(/\s*\(ประเภทเก่า.*\)$/, '');
        }
      }
    });
  }
});
</script>
{% endblock %}
