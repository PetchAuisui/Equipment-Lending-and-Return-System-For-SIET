<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/lend.css') }}" />
  <title>ยืมอุปกรณ์</title>
</head>

{% extends 'base/base.html' %}
{% block title %}ยืมอุปกรณ์{% endblock %}
{% block content %}

<body>
  <!-- Header -->
  <div class="header">
    <i class="ri-file-edit-fill"></i>
    <span>บันทึกการ “ยืม” อุปกรณ์</span>
  </div>
{% if current_user.member_type == 'student' and confirm == True %}
  <!-- Form สำหรับนักศึกษา -->
  <div class="form-container">
    <form action="{{ url_for('inventory.lend_submit') }}" method="POST">
      <!-- รูป + ชื่ออุปกรณ์ + ID -->
      <div class="top-row">
        <img class="image" src="{{ url_for('static', filename=image) }}" alt="{{ name }}" />

        <div class="device-info-box">
          <div class="form-group">
            <label>ชื่ออุปกรณ์</label>
            <input type="text" name="device_name" value="{{ name }}" readonly />
          </div>

          <div class="form-group">
            <label>รหัสอุปกรณ์</label>
            {% if codes|length > 1 %}
              <select name="code">
                {% for c in codes %} 
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input type="text" name="code" value="{{ codes[0] if codes else '' }}" readonly />
            {% endif %}
          </div>
        </div>
      </div>

      <!-- วันที่ยืม + กำหนดคืน -->
      <div class="row">
        <div class="form-group">
          <label>วันที่ยืม</label>
          <input type="date" name="borrow_date" value="{{ now_bangkok|safe_date('%Y-%m-%d') }}" readonly />
        </div>
        <div class="form-group">
          <label>วันที่กำหนดคืน</label>
          <input type="date" name="return_date" required />
        </div>
      </div>

      <!-- ข้อมูลผู้ยืม -->
      <div class="form-group">
        <label>ชื่อ-นามสกุล</label>
        <input type="text" name="borrower_name" value="{{ current_user.name }}" readonly />
      </div>

      <div class="form-group">
        <label>เบอร์โทร</label>
        <input type="text" name="phone" value="{{ current_user.phone }}" readonly />
      </div>

      <!-- วิชา -->
      <div class="form-group">
        <label>วิชา</label>
        <select id="subjectSelect" name="subject" class="auth__input" required>
          <option value="">เลือกวิชา</option>
          {% for subj in subjects %}
            <option value="{{ subj.subject_id }}">{{ subj.subject_name }} ({{ subj.subject_code }})</option>
          {% endfor %}
        </select>
      </div>

      <!-- อาจารย์ -->
      <div class="form-group">
        <label>อาจารย์ประจำวิชา</label>
        <select id="teacherSelect" name="teacher" class="auth__input" required>
          <option value="">เลือกอาจารย์</option>
          {% for t in teachers %}
            <option value="{{ t.user_id }}">{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- เหตุผล -->
      <div class="form-group">
        <label>เหตุผลในการยืม</label>
        <textarea name="reason" rows="3" required></textarea>
      </div>

      <div class="button-group">
        <a href="{{ url_for('inventory.lend_device') }}" type="button" class="btn btn-cancel">ยกเลิก</a>
        <button type="submit" class="btn btn-submit">ยืนยันการยืม</button>
      </div>
    </form>
    <div class="footer-box"></div>
  </div>

{% else %}
  <!-- Form สำหรับบุคลากร -->
  <div class="form-container">
    <form action="{{ url_for('inventory.lend_submit') }}" method="POST">
      <div class="top-row">
        <img class="image" src="{{ url_for('static', filename=image) }}" alt="{{ name }}" />

        <div class="device-info-box">
          <div class="form-group">
            <label>ชื่ออุปกรณ์</label>
            <input type="text" name="device_name" value="{{ name }}" readonly />
          </div>
          <div class="form-group">
            <label>รหัสอุปกรณ์</label>
            {% if codes|length > 1 %}
              <select name="code">
                {% for c in codes %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input type="text" name="code" value="{{ codes[0] if codes else '' }}" readonly />
            {% endif %}
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>วันที่ยืม</label>
          <input type="date" name="borrow_date" value="{{ now_bangkok|safe_date('%Y-%m-%d') }}" readonly />
        </div>
        <div class="form-group">
          <label>วันที่กำหนดคืน</label>
          <input type="date" name="return_date" required />
        </div>
      </div>

      <div class="form-group">
        <label>ชื่อ-นามสกุล</label>
        <input type="text" name="borrower_name" value="{{ current_user.name }}" readonly />
      </div>

      <div class="form-group">
        <label>เบอร์โทร</label>
        <input type="text" name="phone" value="{{ current_user.phone }}" readonly />
      </div>

      <div class="form-group">
        <label>เหตุผลในการยืม</label>
        <textarea name="reason" rows="3" required></textarea>
      </div>

      <div class="button-group">
        <a href="{{ url_for('inventory.lend_device') }}" class="btn btn-cancel">ยกเลิก</a>
        <button type="submit" class="btn btn-submit">ยืนยันการยืม</button>
      </div>
    </form>
    <div class="footer-box2"></div>
  </div>
{% endif %}
</body>

<!-- JS ควบคุมวันที่ -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const borrowInput = document.querySelector('input[name="borrow_date"]');
    const returnInput = document.querySelector('input[name="return_date"]');

    if (borrowInput && returnInput) {
      const borrowDate = new Date(borrowInput.value);
      returnInput.min = borrowInput.value;

      const maxDate = new Date(borrowDate);
      maxDate.setDate(maxDate.getDate() + 5);
      returnInput.max = maxDate.toISOString().split('T')[0];
    }
  });
</script>

<!-- select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
  $('#subjectSelect').select2({ placeholder: "ค้นหาวิชา...", allowClear: false, width: '100%' });
  $('#teacherSelect').select2({ placeholder: "ค้นหาอาจารย์...", allowClear: false, width: '100%' });
});
</script>

{% endblock %}
</html>
