<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/equipment.css') }}">
    <title>Equipment</title>
</head>
{% extends 'base/base.html' %}
{% block content %}

<!-- ===== Header Bar ===== -->
<div class="header-bar">
  <h1 class="Title">ระบบยืมอุปกรณ์</h1>

  <div class="search-container">
      <input type="text" id="searchInput" placeholder="ค้นหาอุปกรณ์..." onkeyup="filterDevices()">
      <select id="categoryFilter" onchange="filterDevices()">
          <option value="">ทุกหมวดหมู่</option>
          {% set categories = (equipments.available + equipments.unavailable) | map(attribute='category') | unique %}
          {% for cat in categories %}
          <option value="{{ cat }}">{{ cat }}</option>
          {% endfor %}
      </select>

  </div>
</div>

<div class="device-container">
    <!-- อุปกรณ์พร้อม -->
     
    {% for item in equipments.available %}
    <div class="device_box" style="background-color: {{ item.status_color }};" 
         data-name="{{ item.name | lower }}" data-category="{{ item.category | lower }}">
        {% if item.image %}
        <img class="image" src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}">
        {% else %}
        <img class="image" src="{{ url_for('static', filename='img/default.png') }}" alt="{{ item.name }}">
        {% endif %}
        <!-- สำหรับรูปที่อาจจะไม่มี-->
        <div class="device_info">
            <span class="device_name">{{ item.name }}</span>
            <span class="amount">จำนวนคงเหลือ : {{ item.amount }}</span>
        </div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function showLoginPopup() {
  // ✅ ตั้ง flag ก่อน redirect
  localStorage.setItem("showLoginAlert", "1");
  // ✅ ไปหน้า login
  window.location.href = "{{ url_for('auth.login_page') }}";
}
</script>

<div class="button_group">
  <a href="#" class="btn btn-detail">รายละเอียด</a>

  {% if current_user.is_authenticated %}
    <a href="{{ url_for('inventory.lend', codes=item.codes|join(','), name=item.name, image=item.image) }}" class="btn btn-borrow">ยืม</a>
  {% else %}
    <a href="#" class="btn btn-borrow" onclick="showLoginPopup()">ยืม</a>
  {% endif %}
</div>







    </div>
    {% endfor %}

    <!-- อุปกรณ์ไม่พร้อม -->
    {% for item in equipments.unavailable %}
    <div class="device_box" style="background-color: {{ item.status_color }};" 
         data-name="{{ item.name | lower }}" data-category="{{ item.category | lower }}">
        <img class="image" src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}">
        <div class="device_info">
            <span class="device_name">{{ item.name }}</span>
            <span class="amount">ไม่พร้อมสำหรับการยืม</span>
        </div>
        <div class="button_group">
            <a href="#" class="btn btn-detail">รายละเอียด</a>
        </div>
    </div>
    {% endfor %}
</div>

<script>
function filterDevices() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const categoryValue = document.getElementById('categoryFilter').value.toLowerCase();
    const devices = document.querySelectorAll('.device_box');

    devices.forEach(device => {
        const name = device.dataset.name;
        const category = device.dataset.category;
        if ((name.includes(searchValue)) && (category.includes(categoryValue) || categoryValue === "")) {
            device.style.display = '';
        } else {
            device.style.display = 'none';
        }
    });
}
</script>


{% endblock %}
</html>
