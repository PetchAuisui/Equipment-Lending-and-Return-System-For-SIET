<nav class="navbar">
  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: Brand + ‡∏õ‡∏∏‡πà‡∏° user (‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π) -->
  <div class="navbar_login">
<div class="nav-left">
  <a class="brand" href="{{ url_for('pages.home') }}">
    <img src="{{ url_for('static', filename='images/logo.png') }}"
         alt="SEIT Equipment"
         style="height: 45px; vertical-align: middle; object-fit: contain;">
  </a>
</div>

    <div class="nav-right">
      {% if current_user.is_authenticated %}
        {% if session.get('role') in ['staff', 'admin'] %}
          {% if request.path.startswith('/admin') %}
            <a href="{{ url_for('pages.home') }}" class="btn-nav btn-admin">Member</a>
          {% else %}
            <a href="{{ url_for('admin.admin_home') }}" class="btn-nav btn-admin">Admin</a>
          {% endif %}
        {% endif %}
        <a href="{{ url_for('auth.logout_action') }}" class="btn-nav btn-logout">Logout</a>
      <span class="user_identity">
        {{ current_user.email | replace('@kmitl.ac.th','') }}
        <i class="ri-user-line"></i>
      </span>

      {% else %}
        <div class="navbar_login_text">
          <a href="{{ url_for('auth.login_page') }}">Login</a>
          <span class="divider">|</span>
          <a href="{{ url_for('auth.register_page') }}">Sign in</a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å + Search (‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô /admin) -->
  {% if not request.path.startswith('/admin') %}
  <div class="navbar_menu">
    <div class="menu-left">
      <a href="{{ url_for('pages.home') }}">Home</a>
      <a href="{{ url_for('inventory.lend_device') }}">Equipment</a>
      <a href="{{ url_for('tracking.track_index') }}">Track Status</a>
      <a href="{{ url_for('pages.policy') }}">Policy</a>
      <a href="{{ url_for('pages.about_us') }}">About Us</a>
    </div>

<div class="navbar_light" style="position: relative;">
  <button class="btn-bell" aria-label="Notifications" style="background:none; border:none; cursor:pointer; position: relative;">
    <i class="ri-notification-4-line" style="font-size: 22px;"></i>
  </button>

  <!-- üîî ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <div id="notif-box"
       style="display:none; position:absolute; right:0; top:40px; 
              background:white; border:1px solid #ddd;
              border-radius:10px; width:320px; max-height:350px;
              overflow-y:auto; box-shadow:0 3px 10px rgba(0,0,0,0.2);
              z-index:9999;">
    <ul id="notif-list" style="list-style:none; margin:0; padding:0;">
      <li style="padding:10px; text-align:center; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</li>
    </ul>
  </div>
</div>

<!-- ‚úÖ Script ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const bellBtn = document.querySelector(".btn-bell");
  const notifBox = document.getElementById("notif-box");
  const notifList = document.getElementById("notif-list");

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á
  bellBtn.addEventListener("click", async () => {
    notifBox.style.display = notifBox.style.display === "block" ? "none" : "block";

    if (notifBox.style.display === "block") {
      try {
        const res = await fetch("/overdue/get-notifications");
        const data = await res.json();
        notifList.innerHTML = "";

        // üü¢ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (API ‡∏™‡πà‡∏á error)
        if (data.error) {
          notifList.innerHTML = `
            <li style="padding:10px; text-align:center; color:#888;">
              ${data.error}
            </li>`;
          return;
        }

        // üü¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (data.length === 0) {
          notifList.innerHTML = `
            <li style="padding:10px; text-align:center; color:#888;">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            </li>`;
          return;
        }

        // üü¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
       data.forEach(n => {
  // ‡πÅ‡∏õ‡∏•‡∏á payload ‡∏à‡∏≤‡∏Å string ‚Üí object
  const payload = typeof n.payload === "string" ? JSON.parse(n.payload) : n.payload;

  notifList.innerHTML += `
    <li style="padding:12px 14px; border-bottom:1px solid #f0f0f0; background:#fff;">
      <div style="display:flex; gap:10px;">
        <div style="flex-shrink:0;">
          <i class="ri-error-warning-line" style="color:#e74c3c; font-size:24px;"></i>
        </div>
        <div style="flex:1;">
          <div style="font-weight:bold; color:#e74c3c; margin-bottom:4px;">
            ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô
          </div>
          <div style="font-size:13px; color:#333; line-height:1.4;">
            ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô <b>${payload.equipment_name || '-'}</b><br>
            (‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${payload.due_date || '-'})
          </div>
          <div style="color:#999; font-size:12px; margin-top:4px;">
            ${n.created_at}
          </div>
        </div>
      </div>
    </li>
  `;
});



      } catch (err) {
        // üî¥ ‡∏ñ‡πâ‡∏≤ fetch ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πà‡∏ô server ‡∏•‡πà‡∏°)
        notifList.innerHTML = `
          <li style="padding:10px; color:red;">
            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </li>`;
      }
    }
  });

  // ‡∏õ‡∏¥‡∏î popup ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á
  document.addEventListener("click", (e) => {
    if (!bellBtn.contains(e.target) && !notifBox.contains(e.target)) {
      notifBox.style.display = "none";
    }
  });
});
</script>


  {% endif %}
</nav>
